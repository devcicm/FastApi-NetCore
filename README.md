 # üöÄ FastApi NetCore

> **Framework ligero y extensible para construir APIs HTTP de alto rendimiento en .NET 8** con arquitectura de middlewares, jerarqu√≠a de autenticaci√≥n avanzada, y pipeline de seguridad optimizado para producci√≥n.

[![.NET 8](https://img.shields.io/badge/.NET-8.0-purple.svg)](https://dotnet.microsoft.com/)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Status](https://img.shields.io/badge/status-Production%20Ready-green.svg)](README.md)

---

## üìã √çndice

* [üéØ Descripci√≥n General](#-descripci√≥n-general)
* [‚ú® Beneficios y Caracter√≠sticas Avanzadas](#-beneficios-y-caracter√≠sticas-avanzadas)
* [üèóÔ∏è Arquitectura del Sistema](#Ô∏è-arquitectura-del-sistema)
* [üîê Jerarqu√≠a de Autenticaci√≥n](#-jerarqu√≠a-de-autenticaci√≥n)
* [‚öôÔ∏è Configuraci√≥n y Despliegue](#Ô∏è-configuraci√≥n-y-despliegue)
* [üõ°Ô∏è Pol√≠ticas de Seguridad](#Ô∏è-pol√≠ticas-de-seguridad)
* [üì° Testing con Postman](#-testing-con-postman)
* [üî¨ Ejemplos de Endpoints](#-ejemplos-de-endpoints)
* [üö¶ Rate Limiting y Performance](#-rate-limiting-y-performance)
* [üìä Monitoreo y Observabilidad](#-monitoreo-y-observabilidad)

## üéØ Descripci√≥n General

**FastApi NetCore** es un framework empresarial para construir **APIs HTTP de alto rendimiento** en **.NET 8** con arquitectura de microservicios. Dise√±ado para aplicaciones cr√≠ticas que requieren **seguridad avanzada**, **escalabilidad** y **observabilidad completa**.

### üîß Caracter√≠sticas Principales

- üõ°Ô∏è **Jerarqu√≠a de Autenticaci√≥n Multicapa**: JWT, API Keys, IP Validation con precedencia configurable
- ‚ö° **Alto Rendimiento**: Pipeline optimizado con middleware as√≠ncrono y pooling de conexiones  
- üîç **Observabilidad Completa**: Logging estructurado, m√©tricas y tracing distribuido
- üö¶ **Rate Limiting Inteligente**: Control de tr√°fico por endpoint, usuario e IP
- üåê **Configuraci√≥n Multi-Entorno**: Development, Staging, Production con hot-reload
- üìä **Validaci√≥n en Tiempo de Compilaci√≥n**: Roslyn Analyzers para pol√≠ticas de seguridad

---

## ‚ú® Beneficios y Caracter√≠sticas Avanzadas

### üè¢ **Para Empresas**
- **‚úÖ Seguridad de Grado Empresarial**: Autenticaci√≥n jer√°rquica, validaci√≥n de pol√≠ticas autom√°tica
- **‚úÖ Escalabilidad Horizontal**: Soporte para load balancing y clustering
- **‚úÖ Compliance y Auditor√≠a**: Logging completo de eventos de seguridad y acceso
- **‚úÖ Zero-Downtime Deployment**: Hot-reload de configuraci√≥n sin reinicio

### üë®‚Äçüíª **Para Desarrolladores**
- **‚úÖ Desarrollo Acelerado**: Auto-registro de rutas con atributos declarativos
- **‚úÖ Debugging Avanzado**: Modo development con bypass de autenticaci√≥n configurable
- **‚úÖ Testing Integrado**: Endpoints de prueba y validaci√≥n autom√°tica de pol√≠ticas
- **‚úÖ IntelliSense Completo**: Validaci√≥n en tiempo de dise√±o con Roslyn

### ‚ö° **Para Operaciones**
- **‚úÖ Monitoreo en Tiempo Real**: Health checks, m√©tricas de performance y alertas
- **‚úÖ Gesti√≥n de Recursos**: Throttling autom√°tico y garbage collection inteligente
- **‚úÖ Configuraci√≥n Centralizada**: appsettings.json con override por variables de entorno
- **‚úÖ Deployment Simplificado**: Single binary con dependencias embebidas

---

## üèóÔ∏è Arquitectura del Sistema

```mermaid
graph TB
    A[HTTP Request] --> B[Request Tracing]
    B --> C[Concurrency Throttle] 
    C --> D[CORS Validation]
    D --> E[Response Cache]
    E --> F[Compression]
    F --> G[Logging Middleware]
    G --> H[IP Filter]
    H --> I[Rate Limiting]
    I --> J[API Key Validation]
    J --> K[JWT Authentication]
    K --> L[Authorization]
    L --> M[Service Provider]
    M --> N[Router & Handlers]
    N --> O[HTTP Response]
```

### üîß **Componentes del Sistema**

| Componente | Responsabilidad | Configuraci√≥n |
|------------|----------------|---------------|
| **üõ°Ô∏è Security Pipeline** | Autenticaci√≥n y autorizaci√≥n multicapa | `ServerConfig.EnableApiKeys`, `JwtSecretKey` |
| **üìä Observability Layer** | Logging, m√©tricas y tracing | `EnableDetailedLogging`, `TrackPerformanceMetrics` |
| **‚ö° Performance Layer** | Rate limiting, compresi√≥n, cach√© | `EnableRateLimiting`, `EnableCompression` |
| **üîß Configuration Manager** | Gesti√≥n de configuraci√≥n multi-entorno | `appsettings.json`, variables de entorno |

---

## üîê Jerarqu√≠a de Autenticaci√≥n

### üìã **Precedencia de Pol√≠ticas (en orden)**

1. **üèõÔ∏è Pol√≠ticas Globales (Clase)**: Se aplican a TODOS los m√©todos del controlador
2. **üéØ Pol√≠ticas Espec√≠ficas (M√©todo)**: Solo cuando no hay pol√≠tica global
3. **‚öôÔ∏è Configuraci√≥n por Defecto**: Fallback desde `appsettings.json`

### üõ°Ô∏è **Tipos de Autenticaci√≥n Soportados**

#### **1. JWT Authentication**
```csharp
[Authorize(Type = AuthorizationType.JWT, Roles = "Admin,Manager")]
public async Task SecureEndpoint(HttpListenerContext context)
{
    // Solo usuarios con roles Admin o Manager pueden acceder
}
```

#### **2. IP Range Validation**  
```csharp
[IpRange(new[] { "192.168.1.0/24", "10.0.0.1-10.0.0.100" })]
public async Task InternalEndpoint(HttpListenerContext context)
{
    // Solo IPs de redes internas pueden acceder
}
```

#### **3. API Key Validation**
```csharp
// Configurado globalmente en ServerConfig.EnableApiKeys = true
// Valida header X-API-Key autom√°ticamente
```

#### **4. Development Mode Bypass**
```csharp
// En modo Development, enviar JSON con keyword configurable:
// {"mode_dev": true, "data": "..."}
// Solo funciona cuando IsProduction = false
```

## ‚öôÔ∏è Configuraci√≥n y Despliegue

### üöÄ **Inicio R√°pido**

1. **Clona el repositorio**:
```bash
git clone https://github.com/devcicm/FastApi-NetCore.git
cd FastApi-NetCore
```

2. **Compila y ejecuta**:
```bash
dotnet build
dotnet run
```

3. **Servidor iniciado**: `http://localhost:8080`

### üìÅ **Estructura de Configuraci√≥n**

```
üì¶ FastApi NetCore/
‚îú‚îÄ‚îÄ üìÑ appsettings.json     # Configuraci√≥n √∫nica centralizada
‚îî‚îÄ‚îÄ üîß Variables de entorno # Override din√°mico para producci√≥n
```

> **‚ö†Ô∏è Nota**: El proyecto usa **√∫nicamente** `appsettings.json` para evitar conflictos de configuraci√≥n. Los perfiles m√∫ltiples fueron removidos para simplificar el despliegue.

### ‚öôÔ∏è **Configuraci√≥n Completa Explicada**

#### **üåê ServerConfig - Configuraci√≥n del Servidor**

```json
{
  "ServerConfig": {
    // üîß === CONFIGURACI√ìN B√ÅSICA DEL SERVIDOR ===
    "HttpPrefix": "http://localhost:8080/",
    // ‚Ü≥ URL base donde escucha el servidor HTTP. DEBE terminar con '/'
    
    "IsProduction": false,
    // ‚Ü≥ Modo de operaci√≥n: false=Development, true=Production
    //   En Development: permite bypass de autenticaci√≥n con keywords
    //   En Production: aplica todas las validaciones de seguridad
    
    "DevelopmentAuthKeyword": "mode_dev",
    // ‚Ü≥ Palabra clave para bypass de autenticaci√≥n en modo Development
    //   Enviar {"mode_dev": true} en el body para saltar JWT
    
    // ‚ö° === CONFIGURACI√ìN DE RENDIMIENTO ===
    "ResponseTimeoutMilliseconds": 30000,
    // ‚Ü≥ Timeout m√°ximo para respuestas HTTP (30 segundos)
    
    "MaxConcurrentConnections": 10000,
    // ‚Ü≥ N√∫mero m√°ximo de conexiones simult√°neas permitidas
    
    "ConnectionTimeoutSeconds": 30,
    // ‚Ü≥ Timeout para establecer nuevas conexiones
    
    "EnableCompression": true,
    // ‚Ü≥ Habilita compresi√≥n gzip/deflate de respuestas HTTP
    //   Reduce el tama√±o de las respuestas en ~70%
    
    "EnableCaching": true,
    // ‚Ü≥ Habilita cach√© de respuestas HTTP en memoria
    //   Mejora performance para requests repetidas
    
    // üîê === CONFIGURACI√ìN JWT ===
    "JwtSecretKey": "super_secret_jwt_key_for_testing_purposes_minimum_32_chars",
    // ‚Ü≥ Clave secreta para firmar/validar tokens JWT (m√≠nimo 32 caracteres)
    //   ‚ö†Ô∏è CAMBIAR en producci√≥n por una clave cryptogr√°ficamente segura
    
    "JwtExcludedPaths": ["/dev/ping", "/dev/echo", "/dev/headers"],
    // ‚Ü≥ Rutas que NO requieren validaci√≥n JWT incluso si tienen [Authorize]
    //   √ötil para endpoints de desarrollo y health checks
    
    // üîë === CONFIGURACI√ìN API KEYS ===
    "EnableApiKeys": false,
    // ‚Ü≥ Habilita/deshabilita el middleware de validaci√≥n de API Keys
    //   false: No valida API Keys globalmente
    //   true: Requiere API Key v√°lida en header X-API-Key
    
    // üö¶ === CONFIGURACI√ìN RATE LIMITING ===
    "EnableRateLimiting": true,
    // ‚Ü≥ Habilita/deshabilita el sistema de rate limiting
    //   Controla la cantidad de requests por ventana de tiempo
    
    // üõ°Ô∏è === CONFIGURACI√ìN DE SEGURIDAD IP ===
    "IpWhitelist": ["127.0.0.1", "::1", "192.168.0.0/16", "10.0.0.0/8"],
    // ‚Ü≥ Lista de IPs/rangos permitidos GLOBALMENTE (aplicado ANTES de handlers)
    //   Formato soportado: IP individual, CIDR, rangos IPv4/IPv6
    
    "IpBlacklist": [],
    // ‚Ü≥ Lista de IPs/rangos BLOQUEADOS globalmente
    //   Tiene precedencia sobre whitelist
    
    "IpMode": "Mixed",
    // ‚Ü≥ Modo de validaci√≥n IP: "Whitelist", "Blacklist", "Mixed"
    //   Mixed: aplica tanto whitelist como blacklist
    
    "EnableIpValidationLogging": true,
    // ‚Ü≥ Habilita logging detallado de validaciones IP
    //   √ötil para debugging y auditor√≠a de accesos
    
    "LogAllIpAttempts": true,
    // ‚Ü≥ Registra TODOS los intentos de conexi√≥n IP (incluso exitosos)
    //   false: solo loggea rechazos y errores
    
    // üìä === CONFIGURACI√ìN DE TRACING Y MONITOREO ===
    "EnableRequestTracing": true,
    // ‚Ü≥ Habilita tracing completo de requests HTTP
    //   Registra inicio, duraci√≥n, status code de cada request
    
    "SlowRequestThresholdMs": 2000,
    // ‚Ü≥ Umbral para marcar requests como "lentas" (2 segundos)
    //   Requests que excedan este tiempo generan logs de WARNING
    
    "TracingExcludedPaths": ["/dev/ping"],
    // ‚Ü≥ Rutas excluidas del tracing para evitar spam en logs
    //   √ötil para health checks muy frecuentes
    
    // üìù === CONFIGURACI√ìN DE LOGGING AVANZADO ===
    "EnableDetailedLogging": true,
    // ‚Ü≥ Habilita logging detallado del sistema
    //   Incluye informaci√≥n de pol√≠ticas, resoluci√≥n, etc.
    
    "LogSecurityEvents": true,
    // ‚Ü≥ Registra todos los eventos de seguridad
    //   Accesos denegados, validaciones fallidas, etc.
    
    "TrackPerformanceMetrics": true,
    // ‚Ü≥ Habilita recopilaci√≥n de m√©tricas de performance
    //   CPU, memoria, tiempos de respuesta, etc.
    
    "LogPolicyResolution": true,
    // ‚Ü≥ Loggea c√≥mo se resuelven las pol√≠ticas de seguridad
    //   Muestra qu√© pol√≠tica (clase/m√©todo/config) se aplica a cada endpoint
    
    "ValidateHandlerPolicyConflicts": true
    // ‚Ü≥ Valida conflictos de pol√≠ticas en tiempo de inicio
    //   Detecta overlaps entre pol√≠ticas globales y espec√≠ficas
  }
}
```

#### **üö¶ RateLimitConfig - Control de Tr√°fico**

```json
{
  "RateLimitConfig": {
    // üéØ === L√çMITES POR DEFECTO ===
    "DefaultRequestLimit": 1000,
    // ‚Ü≥ Requests permitidas por ventana para endpoints SIN [RateLimit]
    
    "DefaultTimeWindow": "00:01:00",
    // ‚Ü≥ Ventana de tiempo por defecto (1 minuto formato HH:MM:SS)
    
    // ‚ö° === CONFIGURACI√ìN DE BURST ===
    "BurstLimit": 500,
    // ‚Ü≥ Requests permitidas en r√°faga antes de aplicar throttling
    
    "WindowSize": "00:00:10",
    // ‚Ü≥ Tama√±o de ventana para detecci√≥n de burst (10 segundos)
    
    // üéØ === REGLAS ESPEC√çFICAS (LEGACY) ===
    "EndpointSpecificRules": {
      // ‚Ü≥ Reglas por endpoint espec√≠fico (DEPRECATED)
      //   Los atributos [RateLimit] tienen PRECEDENCIA sobre estas reglas
      "/legacy-endpoint-without-attributes": {
        "RequestLimit": 5000,
        "TimeWindow": "00:01:00"
      }
    },
    
    // üë§ === REGLAS POR CLIENTE ===
    "ClientSpecificRules": {},
    // ‚Ü≥ Reglas espec√≠ficas por IP de cliente (vac√≠o = no usa)
    
    // üè∑Ô∏è === SISTEMA DE ETIQUETAS ===
    "GlobalTags": ["handler-first"],
    "IndividualTags": ["attribute-precedence"]
    // ‚Ü≥ Tags para categorizaci√≥n y priorizaci√≥n de reglas
  }
}
```

#### **üîë ApiKeyConfig - Gesti√≥n de API Keys**

```json
{
  "ApiKeyConfig": {
    "HeaderName": "X-API-Key",
    // ‚Ü≥ Nombre del header HTTP donde se env√≠a la API key
    
    "RequireApiKey": false,
    // ‚Ü≥ Requiere API key v√°lida para TODOS los endpoints
    //   false: solo endpoints con configuraci√≥n espec√≠fica
    
    "ValidKeys": {
      "demo-key-12345": {
        "Name": "Demo API Key",
        "Roles": ["User"],
        "Enabled": true
      },
      "admin-key-67890": {
        "Name": "Admin Demo Key",
        "Roles": ["Admin"], 
        "Enabled": true
      }
      // ‚Ü≥ Cada key tiene nombre descriptivo, roles asignados y estado
    }
  }
}
```

#### **üîê CredentialConfig - Gesti√≥n de Credenciales**

```json
{
  "CredentialConfig": {
    // üîë === CONFIGURACI√ìN JWT ===
    "JwtExpirationMinutes": 60,
    // ‚Ü≥ Tiempo de vida de tokens JWT (1 hora)
    
    "JwtIssuer": "FastApi_NetCore",
    "JwtAudience": "FastApi_NetCore",
    // ‚Ü≥ Issuer y Audience para validaci√≥n JWT
    
    // üîÑ === REFRESH TOKENS ===
    "RefreshTokenExpirationDays": 30,
    // ‚Ü≥ Tiempo de vida de refresh tokens (30 d√≠as)
    
    "AllowMultipleRefreshTokens": false,
    // ‚Ü≥ Permite m√∫ltiples refresh tokens activos por usuario
    
    "EnableRefreshTokenRotation": true,
    // ‚Ü≥ Rota refresh tokens en cada uso (mayor seguridad)
    
    // üóùÔ∏è === API KEYS DIN√ÅMICAS ===
    "ApiKeyExpirationDays": 365,
    "MaxApiKeysPerUser": 10,
    "ApiKeyPrefix": "fapi_",
    // ‚Ü≥ Configuraci√≥n para API keys generadas din√°micamente
    
    // üîê === CONFIGURACI√ìN DE SEGURIDAD ===
    "TokenExpirationWarningMinutes": 10,
    // ‚Ü≥ Tiempo antes de expiraci√≥n para enviar warnings
    
    "EnableDetailedAuthLogging": true,
    // ‚Ü≥ Logging detallado de eventos de autenticaci√≥n
    
    // üö¶ === RATE LIMITING PARA AUTH ===
    "LoginAttemptsPerMinute": 10,
    "ApiKeyGenerationPerDay": 5,
    "TokenRefreshPerMinute": 5,
    // ‚Ü≥ L√≠mites espec√≠ficos para operaciones de autenticaci√≥n
    
    // üóÑÔ∏è === PERSISTENCIA ===
    "StorageType": "InMemory",
    // ‚Ü≥ Tipo de almacenamiento: "InMemory", "Database", "Redis"
    
    "CleanupExpiredTokensDays": 7,
    // ‚Ü≥ Frecuencia de limpieza de tokens expirados
    
    // üåê === CORS Y ACCESO EXTERNO ===
    "AllowedOrigins": ["http://localhost:3000", "http://localhost:8080"],
    // ‚Ü≥ Or√≠genes permitidos para CORS en endpoints de auth
    
    "EnableExternalTokenValidation": true,
    // ‚Ü≥ Permite validaci√≥n de tokens de proveedores externos
    
    // üìä === MONITOREO ===
    "EnableAuthMetrics": true,
    "EnableSecurityAlerts": true
    // ‚Ü≥ Habilita m√©tricas y alertas de seguridad
  }
}
```

#### **üóÑÔ∏è ConnectionStrings - Base de Datos**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=App;User Id=sa;Password=Password123;"
    // ‚Ü≥ Cadena de conexi√≥n a SQL Server para persistencia
    //   ‚ö†Ô∏è Solo para futura implementaci√≥n, actualmente usa InMemory
  }
}
```

### üåç **Control de Entorno**

El proyecto controla el comportamiento a trav√©s de la propiedad `IsProduction` en `appsettings.json`:

| Modo | IsProduction | Comportamiento |
|------|-------------|----------------|
| **Development** | `false` | ‚úÖ Bypass de autenticaci√≥n con `mode_dev`<br/>‚úÖ Logging detallado habilitado<br/>‚úÖ Validaciones relajadas<br/>‚úÖ Endpoints de desarrollo activos |
| **Production** | `true` | üîí Seguridad m√°xima aplicada<br/>üîí Sin bypass de autenticaci√≥n<br/>üìä Logging optimizado<br/>üö´ Endpoints de desarrollo deshabilitados |

#### **üîÑ Cambio de Modo**

**Opci√≥n 1: Editar `appsettings.json`**
```json
{
  "ServerConfig": {
    "IsProduction": true  // Cambiar a true para modo Production
  }
}
```

**Opci√≥n 2: Variable de entorno (recomendado para producci√≥n)**
```bash
# Windows
set ServerConfig__IsProduction=true
dotnet run

# Linux/Mac  
export ServerConfig__IsProduction=true
dotnet run
```

> **üí° Ventaja**: Un solo archivo de configuraci√≥n evita conflictos y simplifica el despliegue. Las variables de entorno override las configuraciones seg√∫n sea necesario.

---

## üõ°Ô∏è Pol√≠ticas de Seguridad

### üìã **Ejemplos de Pol√≠ticas por Controlador**

#### **üîí Controlador con Pol√≠tica Global (Recomendado)**
```csharp
/// <summary>
/// Todas las operaciones administrativas requieren JWT + rol Admin
/// </summary>
[Authorize(Type = AuthorizationType.JWT, Roles = "Admin")]
[RateLimit(30, 600)] // 30 operaciones por 10 minutos
internal class AdminSystemHandlers
{
    [RouteConfiguration("/admin/system/health", HttpMethodType.GET)]
    internal async Task SystemHealth(HttpListenerContext context)
    {
        // ‚úÖ Hereda: JWT + Admin + Rate limit autom√°ticamente
    }

    [RouteConfiguration("/admin/system/gc-collect", HttpMethodType.POST)]  
    internal async Task ForceGC(HttpListenerContext context)
    {
        // ‚úÖ Hereda: JWT + Admin + Rate limit autom√°ticamente
    }
}
```

#### **üéØ Controlador con Pol√≠ticas Espec√≠ficas por M√©todo**
```csharp
/// <summary>
/// Controlador p√∫blico con autenticaci√≥n selectiva
/// </summary>
[RateLimit(1000, 60)] // Solo rate limiting global
internal class PublicApiHandlers  
{
    [RouteConfiguration("/api/public/status", HttpMethodType.GET)]
    internal async Task GetStatus(HttpListenerContext context)
    {
        // ‚úÖ P√∫blico: Solo rate limiting aplicado
    }

    [RouteConfiguration("/api/public/user-info", HttpMethodType.GET)]
    [Authorize(Type = AuthorizationType.JWT)] // Espec√≠fico del m√©todo
    internal async Task GetUserInfo(HttpListenerContext context)
    {
        // ‚úÖ M√©todo espec√≠fico: JWT requerido
    }
}
```

#### **üåê Controlador con Restricciones de IP**
```csharp
/// <summary>
/// Configuraci√≥n del sistema - Solo desde redes administrativas
/// </summary>
[Authorize(Type = AuthorizationType.JWT, Roles = "Admin,SuperAdmin")]
[IpRange(new[] { "127.0.0.1", "::1", "192.168.1.0/24" })] // IPs administrativas
[RateLimit(10, 300)] // Muy restrictivo
internal class SystemConfigurationHandlers
{
    [RouteConfiguration("/system/configuration", HttpMethodType.GET)]
    internal async Task GetConfiguration(HttpListenerContext context)
    {
        // ‚úÖ Requiere: JWT + Admin + IP v√°lida
    }
}
```

### üîç **Validaci√≥n de Pol√≠ticas en Tiempo de Compilaci√≥n**

El framework incluye **Roslyn Analyzers** que validan las pol√≠ticas durante la compilaci√≥n:

```bash
# Durante dotnet build se ejecuta validaci√≥n autom√°tica:
üîç FastApi NetCore Analyzers v1.0.0 - Validating global policies...
üîç Running Advanced Global Policy Validation...
‚úÖ SUCCESS: All global policy rules are followed correctly!
```

---

## üì° Testing con Postman

### üöÄ **Configuraci√≥n Inicial de Colecci√≥n**

1. **Crea nueva colecci√≥n**: `FastApi NetCore API Tests`
2. **Variables de entorno**:
   ```
   base_url: http://localhost:8080
   api_key: demo-key-12345
   admin_key: admin-key-67890
   ```

### üîì **Testing de Endpoints P√∫blicos**

#### **Health Check**
```http
GET {{base_url}}/health
Accept: application/json
```

**Respuesta esperada (200)**:
```json
{
  "Status": "Healthy",
  "Service": "FastApi NetCore", 
  "Version": "1.0.0",
  "Timestamp": "2025-09-10T21:44:34.8828562Z",
  "Environment": "Development",
  "Uptime": 819,
  "Security": {
    "PolicyApplied": "Rate limited - 1000 requests per minute",
    "AuthRequired": false,
    "PublicEndpoint": true
  }
}
```

#### **Development Ping**
```http
GET {{base_url}}/dev/ping
Accept: application/json
```

**Respuesta esperada (200)**:
```json
{
  "Message": "üèì Ping Response",
  "Description": "Simple ping endpoint for connectivity testing", 
  "Response": "pong",
  "ServerTime": "2025-09-10T21:44:48.1653524Z",
  "RequestInfo": {
    "Method": "GET",
    "ClientIP": "::1",
    "UserAgent": "PostmanRuntime/7.32.2"
  }
}
```

### üîí **Testing de Endpoints Protegidos**

#### **Endpoint Admin (Sin Autenticaci√≥n - Debe Fallar)**
```http
GET {{base_url}}/admin/system/detailed-health
Accept: application/json
```

**Respuesta esperada (401)**:
```json
{
  "Error": "Unauthorized",
  "Message": "Missing or invalid authorization header",
  "Timestamp": "2025-09-10T21:45:10.0189358Z"
}
```

#### **Endpoint Admin (Con Development Mode)**
```http
POST {{base_url}}/admin/system/gc-collect
Content-Type: application/json

{
  "mode_dev": true,
  "comment": "Development authentication bypass"
}
```

**Respuesta esperada (200)**:
```json
{
  "Message": "üóëÔ∏è Garbage Collection Forced (Admin Operation)",
  "Description": "Manual garbage collection triggered - Admin only operation",
  "Operation": {
    "Action": "FORCE_GC", 
    "Status": "COMPLETED",
    "ExecutionTimeMs": 7,
    "Timestamp": "2025-09-10T21:46:15.8606016Z"
  },
  "MemoryStats": {
    "BeforeGC_MB": 7,
    "AfterGC_MB": -2, 
    "FreedMemory_MB": 9
  },
  "Security": {
    "AuthRequired": "JWT + Admin Role (GLOBAL policy)",
    "RateLimit": "30 operations per 10 minutes (GLOBAL policy)",
    "AccessLevel": "System Administrators Only"
  }
}
```

#### **Testing con JWT Token Inv√°lido**
```http
GET {{base_url}}/system/configuration
Authorization: Bearer invalid_jwt_token_here
Accept: application/json
```

**Respuesta esperada (401)**:
```json
{
  "Error": "Unauthorized",
  "Message": "Invalid token", 
  "Timestamp": "2025-09-10T21:48:08.8614409Z"
}
```

### üìä **Testing de Rate Limiting**

#### **Prueba de M√∫ltiples Requests**
```http
# Ejecutar varias veces r√°pidamente
GET {{base_url}}/dev/ping
Accept: application/json
```

**Comportamiento esperado**:
- Primeras 1000 requests/minuto: **Status 200** ‚úÖ
- Requests excedentes: **Status 429** (Too Many Requests) üö´

### üîë **Testing con API Keys**

#### **Con API Key V√°lida** (cuando `EnableApiKeys: true`)
```http
GET {{base_url}}/protected-endpoint
X-API-Key: {{api_key}}
Accept: application/json
```

#### **Sin API Key** (cuando requerida)
```http
GET {{base_url}}/protected-endpoint
Accept: application/json
```

**Respuesta esperada (401)**:
```json
{
  "Error": "Unauthorized",
  "Message": "API key is required"
}
```

## üî¨ Ejemplos de Endpoints

### üìä **Cat√°logo de Endpoints Disponibles**

| Endpoint | M√©todo | Autenticaci√≥n | Rate Limit | Descripci√≥n |
|----------|--------|---------------|------------|-------------|
| `/health` | GET | ‚ùå P√∫blico | 1000/min | Health check del sistema |
| `/dev/ping` | GET | ‚ùå P√∫blico | 1000/min | Ping para connectivity testing |
| `/security/demo/ip-info` | GET | ‚ùå P√∫blico | 100/5min | Demo de informaci√≥n de IP |
| `/admin/system/detailed-health` | GET | üîí JWT + Admin | 30/10min | Health check detallado (Admin) |
| `/admin/system/gc-collect` | POST | üîí JWT + Admin | 30/10min | Forzar garbage collection |
| `/admin/system/environment` | GET | üîí JWT + Admin | 30/10min | Variables de entorno |
| `/system/configuration` | GET | üîí JWT + Admin + IP | 10/5min | Configuraci√≥n del sistema |
| `/auth/login` | POST | ‚ùå P√∫blico | 10/min | Autenticaci√≥n de usuarios |

### üõ†Ô∏è **Ejemplo: Endpoint Completo con Todas las Caracter√≠sticas**

```csharp
/// <summary>
/// Endpoint administrativo con m√°xima seguridad
/// </summary>
[Authorize(Type = AuthorizationType.JWT, Roles = "Admin,SuperAdmin")]
[IpRange(new[] { "127.0.0.1", "::1", "192.168.1.0/24" })]
[RateLimit(5, 300)] // Solo 5 requests cada 5 minutos
[RouteConfiguration("/admin/system/critical-operation", HttpMethodType.POST)]
internal async Task CriticalSystemOperation(HttpListenerContext context)
{
    try
    {
        // 1. Obtener servicios inyectados
        var responseHandler = context.GetService<IHttpResponseHandler>();
        var logger = context.GetService<ILoggerService>();
        
        // 2. Validar usuario autenticado
        var principal = context.GetUserPrincipal();
        var userName = principal?.Identity?.Name ?? "Unknown";
        
        // 3. Leer y validar body de la request
        string requestBody = await ReadRequestBody(context.Request);
        var operationData = JsonSerializer.Deserialize<CriticalOperationRequest>(requestBody);
        
        // 4. Logging de operaci√≥n cr√≠tica
        logger.LogWarning($"[CRITICAL-OP] User {userName} executing: {operationData.Operation}");
        
        // 5. Ejecutar operaci√≥n
        var result = await ExecuteCriticalOperation(operationData);
        
        // 6. Respuesta estructurada
        var response = new
        {
            Message = "üö® Critical Operation Executed",
            Operation = operationData.Operation,
            ExecutedBy = userName,
            Timestamp = DateTime.UtcNow,
            Result = result,
            Security = new
            {
                AuthRequired = "JWT + Admin/SuperAdmin roles",
                IpRestricted = "Local networks only", 
                RateLimit = "5 operations per 5 minutes",
                AuditLogged = true
            }
        };
        
        await responseHandler.SendAsync(context, response, true);
    }
    catch (Exception ex)
    {
        await ErrorHandler.SendErrorResponse(context, HttpStatusCode.InternalServerError, 
            $"Critical operation failed: {ex.Message}");
    }
}
```

### üîê **Body Request Examples**

#### **Development Mode (Solo en Development)**
```json
{
  "mode_dev": true,
  "operation": "restart_service",
  "parameters": {
    "service_name": "cache_service",
    "force": true
  }
}
```

#### **Production Mode (Con JWT v√°lido)**
```json
{
  "operation": "backup_database",
  "parameters": {
    "backup_type": "full",
    "compression": true,
    "retention_days": 30
  },
  "confirmation_code": "BACKUP_CONFIRMED_2025"
}
```

---

## üö¶ Rate Limiting y Performance

### üìä **Configuraci√≥n por Endpoint**

| Tipo de Endpoint | Rate Limit | Justificaci√≥n |
|------------------|------------|---------------|
| **üîì P√∫blicos** | 1000/min | Acceso general, monitoring |
| **üîí Autenticados** | 200/min | Operaciones de usuario |
| **üëë Admin** | 30/10min | Operaciones cr√≠ticas |
| **üö® Cr√≠ticos** | 5/5min | M√°xima protecci√≥n |

### ‚ö° **Optimizaciones de Performance**

#### **Pipeline Optimizado**
```
Request ‚Üí Tracing ‚Üí Throttle ‚Üí Cache ‚Üí Compress ‚Üí Auth ‚Üí Route ‚Üí Response
   ‚Üì         ‚Üì         ‚Üì        ‚Üì        ‚Üì        ‚Üì      ‚Üì        ‚Üì
 0.1ms    0.2ms     0.1ms    0.5ms    1.0ms    0.3ms  2.0ms   0.5ms
```

#### **Configuraci√≥n de Alta Concurrencia**
```json
{
  "ServerConfig": {
    "MaxConcurrentConnections": 10000,
    "EnableCompression": true,
    "EnableCaching": true,
    "EnableRequestTracing": true,
    "SlowRequestThresholdMs": 2000
  }
}
```

---

## üìä Monitoreo y Observabilidad

### üîç **Logging Estructurado**

El framework genera logs estructurados para cada request:

```bash
[INFO] 2025-09-10 21:44:34 - Request started: GET /health
[INFO] 2025-09-10 21:44:34 - [POLICY-RESOLUTION] üîç SystemHealthHandlers.HealthCheck -> /health
[INFO] 2025-09-10 21:44:34 - Request completed: GET /health - Status: 200 - Duration: 2ms
```

### üìà **M√©tricas de Performance**

```bash
[HTTP] Server started successfully:
        Endpoint: http://localhost:8080/
        Max Connections: 10000
        Request Tracing: Enabled
        Compression: Enabled
        Caching: Enabled
        Rate Limiting: Enabled
        Environment: Development
        Ready to accept connections...
```

### üõ°Ô∏è **Auditor√≠a de Seguridad**

```bash
[IP-AUTH] ‚úÖ ACCESS GRANTED:
        Path: /admin/system/detailed-health
        Client IP: 127.0.0.1 (IPv4)
        Method: Whitelist validation
        Reason: IP in global whitelist
        
[SECURITY-POLICY] Global policy for AdminSystemHandlers:
    Authorization: JWT + Roles=[Admin]
    Rate Limit: 30/600s
    Applied to: ALL methods in this controller
```

---

## üöÄ **Despliegue y Producci√≥n**

### üê≥ **Docker (Recomendado)**
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY . .
EXPOSE 8080
ENTRYPOINT ["dotnet", "FastApi NetCore.dll"]
```

### üåê **Variables de Entorno para Producci√≥n**

El proyecto usa **√∫nicamente** `appsettings.json` y permite override con variables de entorno:

```bash
# Configuraci√≥n m√≠nima para producci√≥n
ServerConfig__IsProduction=true
ServerConfig__HttpPrefix=http://0.0.0.0:8080/
ServerConfig__JwtSecretKey=your-production-secret-key-here

# Configuraci√≥n opcional de seguridad
ServerConfig__EnableDetailedLogging=false
ServerConfig__LogPolicyResolution=false
ServerConfig__IpWhitelist__0=10.0.0.0/8
ServerConfig__IpWhitelist__1=172.16.0.0/12
```

> **üí° Nota**: Ya no se usa `ASPNETCORE_ENVIRONMENT` para perfiles m√∫ltiples. El comportamiento se controla √∫nicamente con `IsProduction`.

### üìã **Checklist de Producci√≥n**

- [ ] ‚úÖ `IsProduction: true` configurado
- [ ] ‚úÖ JWT Secret Key segura (m√≠nimo 32 caracteres)
- [ ] ‚úÖ IP Whitelist configurada correctamente
- [ ] ‚úÖ API Keys rotadas y seguras
- [ ] ‚úÖ Rate Limits apropiados para carga esperada
- [ ] ‚úÖ Logging configurado para agregaci√≥n externa
- [ ] ‚úÖ Health checks monitoreados
- [ ] ‚úÖ M√©tricas enviadas a sistema de observabilidad

---

## üîß **Extensibilidad**

### üõ†Ô∏è **Crear Middleware Personalizado**

```csharp
public class CustomSecurityMiddleware : IMiddleware
{
    public async Task InvokeAsync(HttpListenerContext context, Func<Task> next)
    {
        // Tu l√≥gica de seguridad personalizada
        if (await ValidateCustomSecurity(context))
        {
            await next(); // Contin√∫a pipeline
        }
        else
        {
            // Rechaza request
            await ErrorHandler.SendErrorResponse(context, 
                HttpStatusCode.Forbidden, "Custom security validation failed");
        }
    }
}
```

### üì° **Agregar Nuevo Endpoint**

```csharp
[RateLimit(100, 300)]
internal class MyCustomHandlers
{
    [RouteConfiguration("/api/custom/operation", HttpMethodType.POST)]
    [Authorize(Type = AuthorizationType.JWT)]
    internal async Task CustomOperation(HttpListenerContext context)
    {
        // Tu l√≥gica personalizada
        var responseHandler = context.GetService<IHttpResponseHandler>();
        await responseHandler.SendAsync(context, new { 
            Message = "Custom operation executed successfully" 
        }, true);
    }
}
```

---

## üìö **Recursos y Documentaci√≥n**

- üìñ **[Roslyn Analyzers](RoslynAnalyzers/)**: Validadores de pol√≠ticas en tiempo de compilaci√≥n
- üß™ **[Tests de Validaci√≥n](Testers%20feactures/)**: Suite de tests para validar implementaci√≥n
- ‚öôÔ∏è **[Configuraci√≥n](appsettings.json)**: Archivo de configuraci√≥n principal
- üõ°Ô∏è **[Pol√≠ticas de Seguridad](Core/Validation/)**: Validadores de pol√≠ticas jer√°rquicas

### üí° **Contribuir al Proyecto**

1. Fork el repositorio
2. Crea una branch: `git checkout -b feature/nueva-caracteristica`
3. Commit tus cambios: `git commit -m "Add nueva caracteristica"`
4. Push a la branch: `git push origin feature/nueva-caracteristica`
5. Abre un Pull Request

---

## üìÑ **Licencia**

Este proyecto est√° licenciado bajo la [Licencia MIT](LICENSE) - ver el archivo LICENSE para detalles.

---

‚≠ê **¬øTe gusta el proyecto? ¬°Dale una estrella en GitHub!**

üêõ **¬øEncontraste un bug?** [Reporta un issue](https://github.com/devcicm/FastApi-NetCore/issues)

üí¨ **¬øTienes preguntas?** [Inicia una discusi√≥n](https://github.com/devcicm/FastApi-NetCore/discussions)
